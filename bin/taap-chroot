#!/bin/sh -e

[ -d "$1" ]
DIR="$1"
trap 'refcount "$DIR/.refcount" -1 rootmount -u "$DIR"' EXIT
if [ "${USER_MOUNT:-0}" -eq 1 ]; then
    trap 'refcount "$DIR/.refcount_$USER" -1 usermount -u "$DIR"' EXIT
    refcount "$DIR/.refcount_$USER" +1 usermount "$DIR"
fi
refcount "$DIR/.refcount" +1 rootmount "$DIR"

chroot "$@"
