#!/bin/bash
#================================================================
# HEADER
#================================================================
#%Usage: ${SCRIPT_NAME} ACTION
#% Simple restoration of installed programs
#%
#%
#%Action:
#%    install [groups]              Install the user specified groups. If blank defaults to normal
#%    link                          Link files as specified in .links and .links_root. If the target exists and the files aren't the same, the user will be asked to confirm.
#%    list-groups                   Outputs the list of user defined groups
#%    list-installed                Outputs the list of packages installed than are in a user defined group
#%    list-known                    Outputs the list of packages that are in a user defined group
#%    list-uninstalled              Outputs the list of packages in a user defined group that are not installed
#%    list-unknown                  Outputs the list of packages installed than are not in a user defined group
#%    -h, --help                    Print this help
#%    -v, --version                 Print script information
#%
#%
#================================================================
#- IMPLEMENTATION
#-    version         ${SCRIPT_NAME} (taaparthur.no-ip.org)
#-    author          Arthur Williams
#-    license         MIT
#================================================================
# END_OF_HEADER
#================================================================

set -e

export SYSTEM_CONFIG_DIR=${SYSTEM_CONFIG_DIR:-~/SystemConfig}

export makeopts="-A"

displayHelp(){
    SCRIPT_HEADSIZE=$(head -200 ${0} |grep -n "^# END_OF_HEADER" | cut -f1 -d:)
    SCRIPT_NAME="$(basename ${0})"
    head -${SCRIPT_HEADSIZE:-99} ${0} | grep -e "^#[%+]" | sed -e "s/^#[%+-]//g" -e "s/\${SCRIPT_NAME}/${SCRIPT_NAME}/g" ;
}
displayVersion(){
    echo "0.5.0"
}
safeLn() {
    srcFile=$1
    target=$2
    linkTarget=$2
    [ -e $srcFile ]
    if [ -d $target ]; then
        target="$target/$(basename $srcFile)"
    fi
    if [ ! -e $target ] || diff -q $srcFile $target; then
        ln -sf $srcFile $linkTarget
    else
        diff -Ny --suppress-common-lines $srcFile $target || true
        echo "Override  and link $target to $srcFile ? Y/n"
        read -r ans
        if [ "$ans" == Y ] || [ "$ans" == y ]; then
            ln -sf $srcFile $linkTarget
        fi
    fi
}

link(){
    cd $SYSTEM_CONFIG_DIR/Config
    for dotFile in .*; do
        if [ $dotFile == "." ] || [ $dotFile == ".." ]; then
            continue
        elif [ -d $dotFile ]; then
            mkdir -p ~/$dotFile
            for config in "$dotFile"/*; do
                [ -e $config ] && safeLn $PWD/$config ~/$dotFile/
            done
        else
            safeLn $PWD/$dotFile ~/$dotFile
        fi
    done
}

case "$1" in
     link)
         link
         ;;
    help|--help|-h)
        displayHelp
        ;;
    version | --version|-v)
        displayVersion
        ;;
    *)
        echo "Unknown args $*"
        displayHelp
        exit 1
        ;;
esac
