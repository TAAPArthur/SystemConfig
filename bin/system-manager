#!/bin/bash
#================================================================
# HEADER
#================================================================
#%Usage: ${SCRIPT_NAME} ACTION
#% Simple restoration of installed programs
#%
#%
#%Action:
#%    custom                        Interactively let the user to select which scripts to execute from .custom in hooks.json
#%    init                          Executes the scripts in the .scripts in hooks.json
#%    install [groups]              Install the user specified groups. If blank the user can interactively select groups to install.
#%    link                          Link files as specified in .links and .links_root. If the target exists and the files aren't the same, the user will be asked to confirm.
#%    link-normal                   Link files as specified in .links If the target exists and the files aren't the same, the user will be asked to confirm.
#%    link-root                     Link files as specified in .links_root. If the target exists and the files aren't the same, the user will be asked to confirm.
#%    list-groups                   Outputs the list of user defined groups
#%    list-installed                Outputs the list of packages installed than are in a user defined group
#%    list-known                    Outputs the list of packages that are in a user defined group
#%    list-uninstalled              Outputs the list of packages in a user defined group that are not installed
#%    list-unknown                  Outputs the list of packages installed than are not in a user defined group
#%    -h, --help                    Print this help
#%    -v, --version                 Print script information
#%
#%
#================================================================
#- IMPLEMENTATION
#-    version         ${SCRIPT_NAME} (taaparthur.no-ip.org)
#-    author          Arthur Williams
#-    license         MIT
#================================================================
# END_OF_HEADER
#================================================================
#MAN generated with help2man -No system-manager.1 ./system-manager.sh

set -e

export SYSTEM_CONFIG_DIR=${SYSTEM_CONFIG_DIR:-~/SystemConfig}

CACHE_DIR=~/.cache/system-manager
CACHE=$CACHE_DIR/install.txt
mkdir -p $CACHE_DIR
touch $CACHE

displayHelp(){
    SCRIPT_HEADSIZE=$(head -200 ${0} |grep -n "^# END_OF_HEADER" | cut -f1 -d:)
    SCRIPT_NAME="$(basename ${0})"
    head -${SCRIPT_HEADSIZE:-99} ${0} | grep -e "^#[%+]" | sed -e "s/^#[%+-]//g" -e "s/\${SCRIPT_NAME}/${SCRIPT_NAME}/g" ;
}
displayVersion(){
    echo "0.4.0"
}

getAllPackages(){
    cat <(jq -r '. | flatten | join("\n")' $SYSTEM_CONFIG_DIR/packages.json) <(pacman -Qqg base-devel base) |sort|uniq
}
_link(){
    if [[ -z $1 ]]; then
        key=.links
    else
        key=.links_root
    fi
    while read -r src target; do
        target=$(eval echo $target)
        while read -r srcFile ; do
            [[ $target == */ ]] && $1 mkdir -p $target || $1 mkdir -p $(dirname $target);
            if [[ ! -d $target ]] && diff -qN $srcFile $target || diff -qN $srcFile $target$(basename $srcFile); then
                $1 ln -sf $srcFile $target
            else
                $1 ln -si $srcFile $target
            fi
        done < <(eval ls -d $src)
    done < <(jq -r "$key|to_entries|map(\"\(.key) \(.value|tostring)\")|.[]" $SYSTEM_CONFIG_DIR/hooks.json)
}
linkRoot(){
    _link sudo
}
linkNormal(){
    _link
}
linkFiles(){
    linkNormal
    linkRoot
}

options=( $(jq -r 'keys | join(" ")' $SYSTEM_CONFIG_DIR/packages.json |sort))
menu() {
    options=( $* )
    for i in ${!options[@]}; do
        printf "%3d %s) %s\n" $((i+1)) "${options[i]}" 1>&2
    done
}
selectCustom(){
    selectFromMenu $(jq -r '.custom |  keys | join(" ")' $SYSTEM_CONFIG_DIR/hooks.json |sort) |xargs -I{} echo ".custom.{}"
}
listGroups(){
    jq -r '[""] + keys | join(" .")' $SYSTEM_CONFIG_DIR/packages.json |sort
}
selectPackages(){
    selectFromMenu $(listGroups)
}
selectFromMenu(){
    #taken from https://serverfault.com/questions/144939/multi-select-menu-in-bash-script

    while true; do
        menu $*
        read -rp "What do you want installed? " nums
        while read num; do
            if [[ $num == '*' ]]; then
                echo "."
                return 0
            fi
            cmd="echo $num"
            if [[ "$num" == *-* ]]; then
                cmd="seq $(echo "$num" | sed 's/-/ /' )"
            fi
            while read n; do
                [[ "$n" != *[![:digit:]]* ]] &&
                (( n > 0 && n <= ${#options[@]} )) ||
                { echo "Invalid option: $n" 1>&2; continue; }
                ((n--));
                choices[n]="+"
            done < <($cmd)
        done < <(echo "$nums" |sed "s/[ ,]\+/\n/g")
        if [[ ! -z "${choices[*]}" ]]; then
            break
        fi
    done

    for i in ${!options[@]}; do
        [[ "${choices[i]}" ]] && { echo "${options[i]}"; }
    done
    return 0
}

install(){
    echo "Installing $*"
    packages=$(jq -r "$* | flatten | join(\"\n\")" $SYSTEM_CONFIG_DIR/packages.json |sort)
    ${PKG_MANAGER:-sudo pacman} -S $(echo $packages) --needed
}

case "$1" in
    test)
        test
        ;;
    custom)
        shift
        args="$*"
        if [[ -z "$args" ]]; then
            args=$(echo $(selectCustom)|sed "s/ /, /g")
            echo "Selected $args"
        fi
        jq -r "$args " $SYSTEM_CONFIG_DIR/hooks.json | bash
        ;;
    init)
        jq -r '.scripts |join("; ")' $SYSTEM_CONFIG_DIR/hooks.json |bash
        ;;
    reinstall)
        install $(echo $(cat $CACHE) | sed "s/ /, /g")
        ;;
    install)
        shift
        args="$*"
        if [[ -z "$args" ]]; then
            args=$(echo $(selectPackages)|sed "s/ /, /g")
            echo "Selected $args"
        fi
        cat <(echo $args | sed "s/, /\n/g") <(cat $CACHE) | sort -u > $CACHE.tmp
        mv $CACHE.tmp $CACHE
        install $args
        ;;
     link-normal)
         linkNormal
         ;;
     link-root)
         linkRoot
         ;;
     link)
         linkFiles
         ;;
     list-groups)
         listGroups
         ;;
     list-installed)
         comm -12 <(pacman -Qqe|sort) <(getAllPackages)
       ;;
     list-uninstalled)
         comm -13 <(pacman -Qqe|sort) <(getAllPackages)
       ;;
     list-known)
        getAllPackages
       ;;
     list-unknown)
         comm -23 <(pacman -Qqe|sort) <(getAllPackages)
       ;;
     clean)
         [[ "$(pacman -Qtdq)" ]] && sudo pacman -Rns $(pacman -Qtdq)
         extra=$(comm -23 <(pacman -Qqe|sort) <(getAllPackages))
         sudo pacman -Rnsu $extra
         ;;
    help|--help|-h)
        displayHelp
        ;;
    version | --version|-v)
        displayVersion
        ;;
    *)
        echo "Unknown args $*"
        displayHelp
        exit 1
        ;;
esac
