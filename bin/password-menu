#!/bin/sh -e

action=$1
url=$(echo $2/ | rev | sed -E "s|.*/([^.]{,4})\.([^./]+).*$|\1.\2|g"|rev)
shift 2

dir=$PASSWORD_STORE_DIR/$url

getUsername(){
    if [ $(ls $dir | wc -l) -eq 1 ]; then
        username=$(ls $dir)
    elif [ $(ls $dir | wc -l) -eq 0 ]; then
        notify-send "No Users" "There are not users for $url"
        return 1
    else
        username=$(ls $dir | dmenu)
    fi
    basename $username .gpg
}
getPassword(){
    if [ -z $1 ]; then
        username=$(getUsername)
    else
        username=$1
    fi
    tpm show $url/$username
}
setPassword(){
    username=$1
    if [ -z "$username" ]; then
        username=$(zenity --entry --text "Username:")
    fi
    password=$(zenity --password  --text "Password for $username")
    rm -f $dir/$username
    echo $password | tpm insert $url/$username
}
insertPassword(){
    username=$1
    rm -f $dir/$username.gpg
    echo $url/$username
    tpm insert $url/$username
}

case $action in
    get-url)
        echo $url
        ;;
    get-username|u*)
        getUsername
        ;;
    insert-password|i*)
        insertPassword $1
        ;;
    get-both|g*)
        username="$(getUsername)"
        getPassword "$username"
        ;;
    s*)
        setPassword $1
        ;;
    type*)
        sleep 1s;
        username="$(getUsername)"
        password=$(getPassword "$username")
        echo $1 $2 $3 > /tmp/arg.tmp
        echo $* > /tmp/all_arg.tmp
        echo xdotool type -window $1 --clearmodifiers $(printf "$2" $username $password) > /tmp/cmd.tmp
        xdotool type --delay 5 -window $1 --clearmodifiers $(printf "$2" $username $password)
        [ "$3" == "--enter" ] && xdotool key -window $1 --clearmodifiers Return
        ;;

esac
