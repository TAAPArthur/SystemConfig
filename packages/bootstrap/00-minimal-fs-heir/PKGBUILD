# Maintainer: Arthur Williams <taaparthur at gmail dot com>
pkgname=minimal-fs-hier
provides=("filesystem=2020.09.03-1")
pkgver=0.1
pkgrel=3
pkgdesc='Base config files'
arch=('any')
license=('MIT')
backup=(etc/{ld.so.conf,group,gshadow,host.conf,passwd,profile,shadow})
nss() {
echo "passwd: files" >> etc/nss.conf
echo "group: files" >> etc/nss.conf
echo "shadow: files" >> etc/nss.conf
echo "publickey: files" >> etc/nss.conf
echo "hosts: files mymachines myhostname resolve [!UNAVAIL=return] dns" >> etc/nss.conf
echo "networks: files" >> etc/nss.conf
echo "protocols: files" >> etc/nss.conf
echo "services: files" >> etc/nss.conf
echo "ethers: files" >> etc/nss.conf
echo "rpc: files" >> etc/nss.conf
echo "netgroup: files" >> etc/nss.conf
}

package() {
    cd $pkgdir
    umask 133

    for d in boot dev etc home mnt usr/bin usr/lib var opt srv/http run; do
      install -d -m755 $d
    done
    install -d -m555 proc
    install -d -m555 sys
    install -d -m750 root
    install -d -m1777 tmp
    ln -s usr/lib lib
    ln -s usr/lib lib64
    # add bin symlinks
    ln -rs usr/bin bin
    ln -rs usr/bin sbin
    ln -rs bin usr/sbin

    #hacks
    ln -s ../proc/self/mounts etc/mtab

    USER=${USER:-me}
    nss
    echo "include /etc/ld.so.conf.d/*.conf"             >> etc/ld.so.conf
    echo "root:x:0:root"                                >> etc/group
    echo "root:::root"                                  >> etc/gshadow
    echo "multi on"                                     >  etc/host.conf
    echo "root:x:0:0::/root:/bin/bash"                  >> etc/passwd
    echo "export PATH=/opt/bin:/usr/bin:/usr/local/bin" >  etc/.profile
    echo "root::::::::"                                 >> etc/shadow
    touch etc/resolv.conf
    chmod 600 root etc/{shadow,gshadow}
}
